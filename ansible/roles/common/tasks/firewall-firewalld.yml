---
# Firewalld configuration

- name: Check if firewalld is installed
  command: which firewall-cmd
  register: firewalld_check
  changed_when: false
  failed_when: false

- name: Configure firewalld rules
  when: firewalld_check.rc == 0
  block:
    # Server-specific ports
    - name: Allow k3s API (server)
      firewalld:
        port: 6443/tcp
        permanent: yes
        state: enabled
      when: k3s_role == 'server'
      notify: reload firewalld

    # k3s cluster ports
    - name: Allow Macula mesh
      firewalld:
        port: 4433/udp
        permanent: yes
        state: enabled
      when: k3s_role in ['server', 'agent']
      notify: reload firewalld

    - name: Allow EPMD
      firewalld:
        port: 4369/tcp
        permanent: yes
        state: enabled
      when: k3s_role in ['server', 'agent']
      notify: reload firewalld

    - name: Allow Erlang distribution
      firewalld:
        port: 9100/tcp
        permanent: yes
        state: enabled
      when: k3s_role in ['server', 'agent']
      notify: reload firewalld

    - name: Allow Flannel VXLAN
      firewalld:
        port: 8472/udp
        permanent: yes
        state: enabled
      when: k3s_role in ['server', 'agent']
      notify: reload firewalld

    - name: Allow Kubelet
      firewalld:
        port: 10250/tcp
        permanent: yes
        state: enabled
      when: k3s_role in ['server', 'agent']
      notify: reload firewalld

    # Inference node
    - name: Allow Ollama API
      firewalld:
        port: 11434/tcp
        permanent: yes
        state: enabled
      when: k3s_role == 'inference'
      notify: reload firewalld
