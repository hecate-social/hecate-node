---
# FluxCD Installation

- name: Check if flux CLI is installed
  command: which flux
  register: flux_check
  changed_when: false
  failed_when: false

- name: Install FluxCD CLI
  when: flux_check.rc != 0
  shell: |
    curl -s https://fluxcd.io/install.sh | bash
  args:
    creates: /usr/local/bin/flux

- name: Check if flux is bootstrapped
  command: kubectl get namespace flux-system
  register: flux_ns
  changed_when: false
  failed_when: false
  environment:
    KUBECONFIG: "/home/{{ ansible_user }}/.kube/config"

- name: Bootstrap FluxCD
  when: flux_ns.rc != 0
  command: >
    flux install
    --namespace=flux-system
    --components-extra=image-reflector-controller,image-automation-controller
  environment:
    KUBECONFIG: "/home/{{ ansible_user }}/.kube/config"

- name: Wait for flux-system pods
  command: kubectl wait --for=condition=ready pod -l app.kubernetes.io/part-of=flux -n flux-system --timeout=120s
  environment:
    KUBECONFIG: "/home/{{ ansible_user }}/.kube/config"
  changed_when: false

- name: Display FluxCD status
  command: flux check
  register: flux_status
  changed_when: false
  environment:
    KUBECONFIG: "/home/{{ ansible_user }}/.kube/config"

- name: Show flux status
  debug:
    msg: "{{ flux_status.stdout }}"
