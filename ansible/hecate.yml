---
# Hecate Cluster Deployment Playbook
#
# Usage:
#   ansible-playbook -i inventory.ini hecate.yml
#
# Tags:
#   --tags server    - Only server setup
#   --tags agents    - Only agent setup
#   --tags inference - Only inference nodes
#   --tags firewall  - Only firewall rules
#   --tags hecate    - Only Hecate daemon/TUI
#
# Skip:
#   --skip-tags firewall - Skip firewall configuration
#

- name: Common setup for all nodes
  hosts: hecate
  tags: [common]
  roles:
    - common

- name: Setup k3s server (control plane)
  hosts: server
  tags: [server, k3s]
  roles:
    - k3s-server

- name: Setup k3s agents (workers)
  hosts: agents
  tags: [agents, k3s]
  roles:
    - k3s-agent

- name: Setup FluxCD on server
  hosts: server
  tags: [server, flux]
  roles:
    - flux

- name: Setup inference nodes (Ollama only)
  hosts: inference
  tags: [inference]
  roles:
    - inference

- name: Deploy Hecate to k3s cluster
  hosts: server
  tags: [hecate]
  roles:
    - hecate

- name: Show cluster status
  hosts: server
  tags: [status]
  tasks:
    - name: Get node status
      command: kubectl get nodes -o wide
      register: nodes
      changed_when: false

    - name: Get pod status
      command: kubectl get pods -A
      register: pods
      changed_when: false

    - name: Display cluster status
      debug:
        msg: |

          === Cluster Nodes ===
          {{ nodes.stdout }}

          === Pods ===
          {{ pods.stdout }}
